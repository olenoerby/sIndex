<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Browse ‚Äî Pineapple Subreddit Index</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="/fruit-pineapple.svg" type="image/svg+xml">
  <link rel="shortcut icon" href="/fruit-pineapple.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X5E2L44KYG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-X5E2L44KYG');
  </script>
</head>
<body>
  <nav class="main-nav">
    <a href="/" class="nav-link active"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.4 7.7C16.4 6.4 19 7 19 7C17.2 4.6 15.1 4.7 13.6 5.2V5C14.7 3.4 16.9 3.5 16.9 3.5C15.3 2.1 13.9 2.5 13 3C12.5 1.8 12 1 12 1C11.6 1.7 11.3 2.4 11 3.1C10.1 2.5 8.6 2.1 7 3.5C7 3.5 9.3 3.5 10.4 5.2C8.9 4.7 6.8 4.6 5 7C5 7 7.6 6.4 9.6 7.7C7.5 8.9 6 11.7 6 15C6 19.4 8.7 23 12 23S18 19.4 18 15C18 11.7 16.5 8.9 14.4 7.7M15.8 16.8C15.7 17.2 15.6 17.6 15.4 18L14 16L12.5 18L14.1 20.1C13.8 20.3 13.6 20.5 13.3 20.7L12 19L10.7 20.7C10.4 20.6 10.1 20.4 9.9 20.1L11.5 18L10 16L8.5 17.9C8.4 17.5 8.2 17.1 8.1 16.7L9.5 15L8.2 13.2C8.3 12.8 8.4 12.4 8.6 12L10 14L11.5 12L9.9 9.9C10.2 9.7 10.4 9.5 10.7 9.3L12 11L13.3 9.3C13.6 9.4 13.9 9.6 14.1 9.9L12.5 12L14 14L15.5 12.1C15.6 12.5 15.8 12.9 15.9 13.3L14.5 15L15.8 16.8M12 13L13.5 15L12 17L10.5 15L12 13Z" /></svg></span><span class="nav-text">Browse</span></a>
    <a href="/list" class="nav-link"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg></span><span class="nav-text">Advanced</span></a>
    <a href="/discover" class="nav-link"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,1L17.74,3.75L15,5L17.74,6.26L19,9L20.25,6.26L23,5L20.25,3.75M9,4L6.5,9.5L1,12L6.5,14.5L9,20L11.5,14.5L17,12L11.5,9.5M19,15L17.74,17.74L15,19L17.74,20.25L19,23L20.25,20.25L23,19L20.25,17.74" /></svg></span><span class="nav-text">Discover</span></a>
    <a href="/analytics" class="nav-link"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16,11.78L20.24,4.45L21.97,5.45L16.74,14.5L10.23,10.75L5.46,19H22V21H2V3H4V17.54L9.5,8L16,11.78Z" /></svg></span><span class="nav-text">Analytics</span></a>
  </nav>

  <div class="browse-container">
    <div class="browse-header">
      <h1>
        <a href="/" style="color:inherit;text-decoration:none">Œ® Pineapple Subreddit Index</a>
      </h1>
      <p class="subtitle">Browse and discover subreddits</p>
    </div>

    <!-- Search section -->
    <div class="search-section">
      <div class="search-wrapper" style="display:flex;gap:8px;align-items:center">
        <div style="position:relative;flex:1">
          <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="Search subreddits..." 
            maxlength="200"
          />
          <button id="searchClear" class="search-clear" title="Clear search">√ó</button>
        </div>
        <button id="refreshBtn" class="page-btn" title="Refresh" style="padding:14px 18px;font-size:18px;min-width:auto">‚Üª</button>
      </div>
    </div>

    <!-- Simple filters -->
    <div class="filter-bar">
      <select id="sortBy" class="sort-select">
        <option value="mentions">Popular (Mentions)</option>
        <option value="subscribers">Most Subscribers</option>
        <option value="active_users">Most Active</option>
        <option value="first_mentioned">Recently Discovered</option>
        <option value="created_utc">Newest Subreddits</option>
        <option value="display_name_prefixed">A-Z (Alphabetical)</option>
        <option value="random">Random</option>
      </select>
      
      <button id="filterAll" class="filter-chip" data-filter="all">All</button>
      <button id="filterNSFW" class="filter-chip active" data-filter="nsfw">NSFW Only</button>
      <button id="filterSFW" class="filter-chip" data-filter="sfw">SFW Only</button>
    </div>

    <!-- Results info -->
    <div class="results-info" id="resultsInfo">
      Loading...
    </div>

    <!-- Subreddit grid -->
    <div class="subreddit-grid" id="subredditGrid">
      <!-- Cards will be inserted here -->
    </div>

    <!-- Status message (loading, error, empty) -->
    <div class="status-message" id="statusMessage" style="display:none;">
      <div class="loading-spinner"></div>
      <p style="margin-top:12px">Loading subreddits...</p>
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination">
      <button id="prevPage" class="page-btn">‚Üê Previous</button>
      <span id="pageInfo" class="page-info">Page 1</span>
      <button id="nextPage" class="page-btn">Next ‚Üí</button>
    </div>

    <!-- Link to advanced view -->
    <div class="advanced-link">
      <a href="/list">Need more filters? Try the Advanced View ‚Üí</a>
    </div>
  </div>

  <script>
    // State management
    let currentPage = 1;
    let totalResults = 0;
    let perPage = 24;
    let currentSort = 'mentions';
    let previousSort = 'mentions'; // Store sort before search
    let currentFilter = 'nsfw';
    let searchQuery = '';
    let isLoading = false;

    // DOM elements
    const searchInput = document.getElementById('searchInput');
    const searchClear = document.getElementById('searchClear');
    const refreshBtn = document.getElementById('refreshBtn');
    const sortBy = document.getElementById('sortBy');
    const filterChips = document.querySelectorAll('.filter-chip');
    const subredditGrid = document.getElementById('subredditGrid');
    const statusMessage = document.getElementById('statusMessage');
    const resultsInfo = document.getElementById('resultsInfo');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');

    // Normalize user-entered subreddit queries to a bare subreddit name.
    // Accepts forms like '/r/name', 'r/name', 'https://reddit.com/r/name', or 'rname'.
    function normalizeQuery(raw) {
      try {
        const qraw = String(raw || '').trim();
        // strip full reddit URL
        let q = qraw.replace(/^https?:\/\/(?:www\.)?reddit\.com\/r\//i, '');
        // strip leading /r/ or r/ 
        q = q.replace(/^\/?r\//i, '').trim();
        // accept shorthand rname
        const m = qraw.match(/^r([A-Za-z0-9_]{3,21})$/i);
        if (m && m[1]) q = m[1];
        return q;
      } catch(e) {
        return String(raw || '').trim();
      }
    }

    // Utility: Format numbers with K/M suffixes
    function formatNumber(num) {
      if (!num) return '0';
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    // Utility: Format date
    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      // Handle Unix timestamps (seconds) - convert to milliseconds
      const timestamp = typeof dateStr === 'number' ? dateStr * 1000 : dateStr;
      const date = new Date(timestamp);
      const now = new Date();
      const days = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      
      if (days === 0) return 'Today';
      if (days === 1) return 'Yesterday';
      if (days < 7) return `${days} days ago`;
      if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
      if (days < 365) return `${Math.floor(days / 30)} months ago`;
      return `${Math.floor(days / 365)} years ago`;
    }

    // Decode HTML entities
    function decodeHtml(html) {
      const txt = document.createElement('textarea');
      txt.innerHTML = html;
      return txt.value;
    }

    // Create subreddit card
    function createSubredditCard(sub) {
      const card = document.createElement('div');
      card.className = 'sub-card' + (sub.over18 ? ' nsfw' : '');
      
      const isUnavailable = sub.is_banned || sub.subreddit_found === false;
      
      let statusBadge = '';
      if (sub.over18) {
        statusBadge = '<span class="nsfw-badge">NSFW</span>';
      }
      if (isUnavailable) {
        statusBadge += '<span class="unavailable-badge">Unavailable</span>';
      }

      const title = decodeHtml(sub.title || 'No title');
      const description = decodeHtml(sub.description || 'No description available');
      
      card.innerHTML = `
        <h3 class="sub-name">
          ${sub.display_name_prefixed || sub.name}
          ${statusBadge}
        </h3>
        <p class="sub-title">${title}</p>
        <p class="sub-description">${description}</p>
        <div class="sub-stats">
          <div class="stat-item">
            <span>üí¨</span>
            <span class="stat-value">${formatNumber(sub.mentions || 0)}</span>
            <span>mentions</span>
          </div>
          <div class="stat-item">
            <span>üë•</span>
            <span class="stat-value">${formatNumber(sub.subscribers || 0)}</span>
            <span>members</span>
          </div>
          <div class="stat-item">
            <span>üîé</span>
            <span class="stat-value">${formatDate(sub.first_mentioned)}</span>
          </div>
        </div>
      `;

      // Click to open subreddit
      card.addEventListener('click', () => {
        const subName = sub.display_name || sub.name || '';
        if (subName) {
          window.open(`https://reddit.com/r/${subName}`, '_blank', 'noopener,noreferrer');
        }
      });

      return card;
    }

    // Build API URL with filters
    function buildApiUrl() {
      const params = new URLSearchParams({
        page: currentPage,
        per_page: perPage,
        sort: currentSort,
        sort_dir: 'desc'
      });

      if (searchQuery) {
        params.append('q', normalizeQuery(searchQuery));
      }

      // Filter by NSFW/SFW - using show_nsfw and show_non_nsfw parameters
      if (currentFilter === 'nsfw') {
        params.append('show_nsfw', 'true');
        params.append('show_non_nsfw', 'false');
      } else if (currentFilter === 'sfw') {
        params.append('show_nsfw', 'false');
        params.append('show_non_nsfw', 'true');
      } else {
        // Show all - include both NSFW and SFW
        params.append('show_nsfw', 'true');
        params.append('show_non_nsfw', 'true');
      }

      // Only show available subreddits by default
      params.append('show_available', 'true');
      params.append('show_banned', 'false');

      return `/subreddits?${params.toString()}`;
    }

    // Load subreddits from API
    async function loadSubreddits() {
      if (isLoading) return;
      
      isLoading = true;
      subredditGrid.style.display = 'none';
      statusMessage.style.display = 'block';
      statusMessage.innerHTML = `
        <div class="loading-spinner"></div>
        <p style="margin-top:12px">Loading subreddits...</p>
      `;

      try {
        const response = await fetch(buildApiUrl());
        if (!response.ok) throw new Error('Failed to fetch');

        const data = await response.json();
        
        totalResults = data.total || 0;
        const subreddits = data.items || [];

        // Update results info
        const start = (currentPage - 1) * perPage + 1;
        const end = Math.min(currentPage * perPage, totalResults);
        resultsInfo.innerHTML = `
          Showing <strong>${start}-${end}</strong> of <strong>${formatNumber(totalResults)}</strong> subreddits
        `;

        // Clear grid and render cards
        subredditGrid.innerHTML = '';
        
        if (subreddits.length === 0) {
          statusMessage.innerHTML = '<p>No subreddits found. Try adjusting your filters.</p>';
          statusMessage.style.display = 'block';
          subredditGrid.style.display = 'none';
        } else {
          subreddits.forEach(sub => {
            subredditGrid.appendChild(createSubredditCard(sub));
          });
          statusMessage.style.display = 'none';
          subredditGrid.style.display = 'grid';
        }

        // Update pagination
        updatePagination();

      } catch (error) {
        console.error('Error loading subreddits:', error);
        statusMessage.innerHTML = '<p>Error loading subreddits. Please try again.</p>';
        statusMessage.style.display = 'block';
        subredditGrid.style.display = 'none';
      } finally {
        isLoading = false;
      }
    }

    // Update pagination buttons
    function updatePagination() {
      const totalPages = Math.ceil(totalResults / perPage);
      
      prevPage.disabled = currentPage <= 1;
      nextPage.disabled = currentPage >= totalPages;
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    }

    // Event listeners
    searchInput.addEventListener('input', (e) => {
      const newQuery = e.target.value.trim();
      const hadQuery = searchQuery.length > 0;
      const hasQuery = newQuery.length > 0;
      searchQuery = newQuery;
      searchClear.style.display = searchQuery ? 'block' : 'none';
      
      // Auto-switch to alphabetical sort when searching (for relevance)
      if (hasQuery && !hadQuery) {
        // Just started searching - save current sort and switch to A-Z
        previousSort = currentSort;
        currentSort = 'display_name_prefixed';
        sortBy.value = currentSort;
      } else if (!hasQuery && hadQuery) {
        // Just cleared search - restore previous sort
        currentSort = previousSort;
        sortBy.value = currentSort;
      }
      
      // Debounce search
      clearTimeout(searchInput.timeout);
      searchInput.timeout = setTimeout(() => {
        currentPage = 1;
        loadSubreddits();
      }, 500);
    });

    searchClear.addEventListener('click', () => {
      searchInput.value = '';
      if (searchQuery.length > 0) {
        // Restore previous sort when clearing search
        currentSort = previousSort;
        sortBy.value = currentSort;
      }
      searchQuery = '';
      searchClear.style.display = 'none';
      currentPage = 1;
      loadSubreddits();
    });

    refreshBtn.addEventListener('click', () => {
      currentPage = 1;
      loadSubreddits();
    });

    sortBy.addEventListener('change', (e) => {
      currentSort = e.target.value;
      // Update previousSort if not currently searching
      if (!searchQuery) {
        previousSort = currentSort;
      }
      currentPage = 1;
      loadSubreddits();
    });

    filterChips.forEach(chip => {
      chip.addEventListener('click', () => {
        filterChips.forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        currentFilter = chip.dataset.filter;
        currentPage = 1;
        loadSubreddits();
      });
    });

    prevPage.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        loadSubreddits();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });

    nextPage.addEventListener('click', () => {
      const totalPages = Math.ceil(totalResults / perPage);
      if (currentPage < totalPages) {
        currentPage++;
        loadSubreddits();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });

    // Cookie functions for age gate
    function setCookie(name, value, days) {
      const date = new Date();
      date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
      document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
    }

    function getCookie(name) {
      const nameEQ = name + '=';
      const cookies = document.cookie.split(';');
      for (let c of cookies) {
        c = c.trim();
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
      }
      return null;
    }

    // Age gate modal
    function showAgeGate(onConfirm) {
      const overlay = document.createElement('div');
      overlay.className = 'age-modal-overlay';
      const box = document.createElement('div');
      box.className = 'age-modal-box';
      const h = document.createElement('h2');
      h.textContent = 'Age confirmation';
      const p = document.createElement('p');
      p.textContent = 'This page may contain explicit (18+) content. Please confirm that you are of the required age to visit this website.';
      const actions = document.createElement('div');
      actions.className = 'age-modal-actions';
      const confirmBtn = document.createElement('button');
      confirmBtn.className = 'btn';
      confirmBtn.textContent = 'I am 18+';
      const leaveBtn = document.createElement('button');
      leaveBtn.className = 'btn btn-ghost';
      leaveBtn.textContent = 'Leave';
      actions.appendChild(leaveBtn);
      actions.appendChild(confirmBtn);
      box.appendChild(h);
      box.appendChild(p);
      box.appendChild(actions);
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      document.body.style.overflow = 'hidden';

      confirmBtn.addEventListener('click', () => {
        try { setCookie('sindex_age_confirmed', '1', 365); } catch(e) {}
        overlay.remove();
        document.body.style.overflow = '';
        onConfirm();
      });

      leaveBtn.addEventListener('click', () => {
        try { overlay.remove(); } catch(e) {}
        window.location.href = 'about:blank';
      });

      confirmBtn.focus();
    }

    // Check age confirmation and load
    function initWithAgeGate() {
      try {
        const confirmed = getCookie('sindex_age_confirmed');
        if (confirmed === '1') {
          loadSubreddits();
          return;
        }
      } catch(e) { /* ignore and show gate */ }
      showAgeGate(() => loadSubreddits());
    }

    // Initial load with age gate
    initWithAgeGate();
  </script>
</body>
</html>
